<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Khan Academy Infection Demo</title>
    <style>
      html {
        background-color: #394551;
        text-align: center;
      }
      .node {
        stroke: #394551;
        stroke-width: 1.5px;
      }
      .link {
        stroke: #aaa;
        stroke-opacity: .6;
        stroke-width: 2px;
      }
    </style>
  </head>
  <body>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script>
      var graph = {
        0: [1, 2],
        1: [3],
        2: [3],
        3: [],
        4: [5, 6, 7],
        5: [],
        6: [7],
        7: [8],
        8: [],
        9: [],
        10: [],
        11: [],
        12: [13, 14, 15, 16, 17, 18, 19, 20],
        13: [],
        14: [],
        15: [],
        16: [],
        17: [],
        18: [],
        19: [],
        20: [],
      };

      // Make a map of just the keys
      var nodes = [];
      Object.keys(graph).forEach(function(key) {
        nodes.push({id: key, version: 0});
      });

      // Create a list of all relationships
      var links = [];
      Object.keys(graph).forEach(function(nodeA) {
        graph[nodeA].forEach(function(nodeB) {
          links.push({source: nodes[nodeA], target: nodes[nodeB]});
        });
      });

      var width = 960,
        height = 600;

      var color = d3.scale.category10();

      var force = d3.layout.force()
        .charge(-120)
        .linkDistance(40)
        .size([width, height])
        .nodes(nodes)
        .links(links)
        .start();

      var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

      var link = svg.selectAll(".link")
          .data(links)
        .enter().append("line")
          .attr("class", "link");

      var node = svg.selectAll(".node")
          .data(nodes);

      node.enter().append("circle")
        .attr("class", "node")
        .attr("r", 10)
        .style("fill", function(d) {
          return color(d.version);
        })
        .call(force.drag);

      force.on("tick", function() {
        link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        node.attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; });
      });

      new_version = 0;

      node.on('click', function(d) {
        d3.json('/infect?type=total&user=' + d.id)
          .header("Content-Type", "application/json")
          .post(JSON.stringify(graph), function(error, data) {
            if (error) return console.warn(error);
            new_version++;
            data.users.forEach(function(id) {
              nodes[id].version = new_version;
            });
            node.style('fill', function(d) {
              return color(d.version);
            });
          });
      });
    </script>
  </body>
</html>
